# Claude Code CDK ETL Auto Test

## Overview

Claude Code skills and CloudFormation templates for
safely operating AWS from Claude Code,
plus a CDK sample project demonstrating
automated integration testing with the Ralph Loop pattern.

- `prepare-integration-test` skill generates test plans
  and workflow definitions for Ralph Loop execution

## Architecture

See `drawio/etl_pipeline_and_ralph_loop.drawio`
for detailed diagrams.

```text
.
├── credential-process-mfa.sh             # credential_process for MFA + assume-role
├── .claude/                               # Claude Code project config (not committed)
│   └── settings.local.json               #   Permissions (not committed)
├── skills/                                # Claude Code skills
│   └── prepare-integration-test/          #   Integration test prep (Ralph Loop)
│       ├── SKILL.md
│       ├── references/
│       │   ├── INSTRUCTIONS.md            #     Skill detailed steps
│       │   ├── orchestrator-prompt.md     #     Prompt template for claude -p
│       │   └── test-cases-template.md     #     Test plan / evidence template
│       └── scripts/
│           └── run-integration-test.sh    #     Ralph Loop launcher
├── drawio/                                # Architecture diagrams
│   ├── architecture_etl_pipeline.drawio
│   └── architecture_ralph_loop.drawio
├── cfn/                                   # CloudFormation templates
│   └── claude-code-resources.yaml         #   IAM role + Athena WorkGroup
└── eventbridge-sfn-iceberg/               # CDK sample project
    ├── .claude/
    │   └── settings.json                  #   Project-level settings
    ├── cdk/                               #   CDK infra code (TypeScript)
    ├── resources/                         #   Lambda / test data
    └── test-outputs/                      #   Test plan + evidence + workflow (generated by skill)
        └── workflow.json                  #   Ralph Loop workflow definition
```

## Prerequisites

- AWS CLI v2
- Python 3.9+
- Node.js 18+ and pnpm
- An AWS account with permission to deploy CloudFormation stacks
- IAM user with MFA device configured
- `~/.aws/config` with a `credential_process` profile
  for the target account (handles MFA + assume-role)

The IAM role deployed in Setup requires MFA (`aws:MultiFactorAuthPresent`),
so assume-role without MFA will be rejected.
Authentication is handled by AWS CLI's `credential_process` mechanism.
A reference implementation using 1Password CLI is provided in `credential-process-mfa.sh`,
but any `credential_process` script (or SSO profile)
that returns valid credentials will work.

## Setup

### 1. Deploy Shared Resources

Deploy the CloudFormation template to create the IAM role and Athena WorkGroup.

- `ProjectName` (kebab-case, e.g. `my-project`) is used
  for resource naming (Athena WorkGroup, tags)
- `RoleNamePrefix` (PascalCase, e.g. `MyProject`) is used for the IAM role name

This creates the following resources:

- `{RoleNamePrefix}ClaudeCodeOperatorRole` - IAM role
  (ReadOnlyAccess + limited write, MFA required)
- `{ProjectName}-claude-code` - Athena WorkGroup (ManagedQueryResults enabled)

```bash
aws cloudformation deploy \
  --template-file cfn/claude-code-resources.yaml \
  --stack-name claude-code-resources \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides \
    ProjectName=<your-project-name> \
    RoleNamePrefix=<YourPrefix> \
    TrustedPrincipalArns=<arn:aws:iam::123456789012:user/alice>
```

### 2. Deploy CDK Sample

`eventbridge-sfn-iceberg/` is an
EventBridge + Step Functions + Iceberg ETL pipeline.

Edit `cdk/lib/parameter.ts` and set `projectName`
to your project name.
This value is used as a prefix for all resource names
(S3 buckets, Lambda, Step Functions, etc.).

```bash
cd eventbridge-sfn-iceberg/cdk
pnpm install
pnpm exec cdk deploy --all --profile <your-profile>
```

### 3. Place Skills and Hook

Copy the skill directory to your target repository.
Claude Code automatically loads skills from `.claude/skills/`.

```bash
mkdir -p <your-repo>/.claude/skills/
cp -r 65_aws_cdk_etl_auto_test/skills/prepare-integration-test <your-repo>/.claude/skills/
```

Copy the credential script to your project's `.claude/` directory.

```bash
cp 65_aws_cdk_etl_auto_test/credential-process-mfa.sh <your-repo>/.claude/
```

## Usage

### 1. Create Test Plan

Start a Claude Code session and run `/prepare-integration-test`.
The skill analyzes the CDK code and design docs,
then generates a test plan (`test-outputs/test-plan.md`)
and workflow definition (`test-outputs/workflow.json`).

### 2. Execute Tests with Ralph Loop

Launch the Ralph Loop script from a separate terminal tab.
Do not run this from Claude Code's Bash tool.

```bash
cd eventbridge-sfn-iceberg
bash skills/prepare-integration-test/scripts/run-integration-test.sh test-outputs/workflow.json
```

The script invokes `claude -p` in a loop (Ralph Loop pattern).
Each iteration processes one pending step and exits.
The shell script waits for `interval` seconds (from workflow.json) and re-invokes.
If interrupted, re-run the same command to resume from the last completed step.

The final step writes a test summary to `test-outputs/test-plan.md`.
If the summary reveals issues, fix the code and run
`/prepare-integration-test` again
to trigger a re-test cycle.

---

## Reference

### Ralph Loop Design

Claude Code interactive sessions are limited by the context window and session stability.
Long-running workflows like integration tests
(spanning hours) cannot complete in a single session.

Ralph Loop solves this by having a shell script invoke
`claude -p` (pipe mode) repeatedly in a `for` loop.
Each invocation processes one pending step and exits.
The shell script reads `interval` from workflow.json,
sleeps between iterations, and checks whether all steps are completed.
State is persisted in workflow.json
(read/written directly by `claude -p` after each step).
If the process is interrupted, re-running the same command
resumes from the last completed step.

Reference: [Geoffrey Huntley -- everything is a ralph loop](https://ghuntley.com/loop/)

#### Why Shell Script Ralph Loop

Anthropic's official ralph-wiggum plugin also implements the Ralph Loop pattern,
but it uses a Stop Hook that affects session-wide behavior.
Running all steps as a skill in an interactive session was also considered,
but every AWS CLI tool call triggers a permission prompt.
Bypassing this requires `--dangerously-skip-permissions`,
which unconditionally allows all tools — too broad for safe AWS operations.

`claude -p` + `--allowedTools` allows pattern-based tool auto-approval
(e.g., `Bash(aws *)` is allowed while `rm`, `curl`, etc. are blocked).
This safe auto-approval model is the primary reason for choosing the shell script approach.
Additionally, `claude -p` starts as a fresh process each invocation,
so context does not accumulate and long workflows remain stable.

Reference: [anthropics/claude-code plugins/ralph-wiggum](https://github.com/anthropics/claude-code/blob/main/plugins/ralph-wiggum/README.md)

#### Architecture

The shell script invokes `claude -p` in a loop.
Each iteration processes one pending step and exits.
Async jobs are checked once per invocation (no polling loops).
The shell script sleeps for `interval` seconds between iterations.
`workflow.json` is updated after each step, enabling resume on interruption.

```text
Terminal (user launches)
  └─ run-integration-test.sh (shell script)
       │
       └─ for loop (max-iterations):
            ├─ Build prompt from orchestrator-prompt.md template
            ├─ Launch: claude -p --model "$MODEL" --allowedTools "$ALLOWED_TOOLS_STR" --verbose
            │    └─ Read workflow.json
            │    └─ Walk steps: skip completed / already-started
            │    └─ Process first actionable step:
            │         ├─ Check async status once (no polling loop)
            │         ├─ If still running → leave as "in_progress", exit
            │         ├─ If terminal → update to "completed", exit
            │         └─ Update workflow.json (status/output/retry)
            ├─ Check: all steps completed? → exit 0
            ├─ Sleep interval seconds
            └─ Log: test-outputs/.workflow-log (stream-json)
```

Each `claude -p` invocation:

1. Reads workflow.json following the orchestrator prompt,
   finds the next pending or in-progress step
2. Updates status to "in_progress", executes or checks status once
3. If async job is still running, exits immediately
   (the outer loop handles the wait)
4. If step completes, updates to "completed" with output, then exits
5. On interruption, workflow.json retains the last persisted state for resume

`claude -p` reads and writes workflow.json directly.
State management (retry logic, placeholder resolution)
is instructed via the orchestrator prompt and executed by `claude -p`.
The shell script handles loop control, sleep intervals, and completion detection.

#### Skill and Script Responsibilities

Ralph Loop workflows are split into Phase 1 (preparation) and Phase 2 (execution).
If the test summary reveals issues, a re-test cycle is triggered after code fixes.

| Phase | Environment | Owner | Actions |
| --- | --- | --- | --- |
| Phase 1 (initial) | Claude Code interactive | Skill | Generate test plan + workflow.json, user approval |
| Phase 2 (initial) | Terminal (manual launch) | Shell script + `claude -p` | Execute steps, record evidence, write summary |
| Phase 1 (re-test) | Claude Code interactive | Skill | Check re-test targets, regenerate workflow.json |
| Phase 2 (re-test) | Terminal (manual launch) | Shell script + `claude -p` | Re-run tests, record evidence, update summary |

Phase 1 is handled by the skill.
All user interaction (review, approval, parameter confirmation) completes here.
The skill presents the script launch command at the end.
On re-test, the skill detects summary findings
in test-plan.md and automatically switches
to re-test mode.

Phase 2 is handled by the script.
The user launches it from a separate terminal tab.
Do not run `run-integration-test.sh` from Claude Code's Bash tool
(this creates a nested `claude -p` structure).
The last step in workflow.json is a summary step
that records the overall assessment in test-plan.md.

#### State Management and Resume

`workflow.json` serves as both task definition and state storage.
The `status`, `output`, and `retry` fields are the source of truth.
`test-outputs/.workflow-log` records the stream-json output for debugging.

| Field | Role |
| --- | --- |
| `status` | `pending` → `in_progress` → `completed` (per step) |
| `output` | Step result (execution ARN, response JSON, etc.) |
| `retry` | Current retry count for the step |

Resume behavior on interruption:

- `"status": "completed"` → skip (already done)
- `"status": "in_progress"` with `"output"` set
  → job was started; mark as completed and exit (next invocation handles check step)
- `"status": "in_progress"` with `"output": null` → re-execute from the beginning
- `"status": "pending"` → execute normally

Async job status is checked once per `claude -p` invocation
(no polling loops). If the job is still running,
the step remains as `"in_progress"` and `claude -p` exits.
The outer Ralph Loop sleeps for `interval` seconds
and re-invokes to check again.

Retry logic on test failure is instructed
via the orchestrator prompt.
`claude -p` references `max_retries` in workflow.json
and infers execute/check step pairs from the naming convention
(`N-check` → `N-execute`).

#### Component Mapping

| Component | Path | Role |
| --- | --- | --- |
| Skill (Phase 1) | `skills/prepare-integration-test/` | Test preparation (test spec + prerequisites + workflow.json generation) |
| Shell script (Phase 2) | `skills/prepare-integration-test/scripts/run-integration-test.sh` | Ralph Loop orchestrator |

### AWS Operations Design

`--allowedTools` allows `Bash(aws *)` for AWS CLI operations,
while a dedicated IAM role (`cfn/claude-code-resources.yaml`)
denies destructive AWS API calls.
The IAM role uses `ReadOnlyAccess` as a base
with minimal write permissions for test execution
(Step Functions start, Athena queries, S3 test data upload, etc.),
MFA required, and a 1-hour session limit.

For environments where the IAM role has broader permissions,
use finer-grained `--allowedTools` patterns
or deny specific AWS commands via Hooks (`PreToolUse`).

Reference: [kawarimidoll -- Hooks でのコマンド制限](https://zenn.dev/kawarimidoll/articles/7da5fd40f19fb1)
